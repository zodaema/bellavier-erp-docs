# Task 27.26 Phase 2a Review - Issues Found & Fixed

**Date:** 2025-12-09  
**Phase:** 2a - Extract Read-Only Actions  
**Status:** ğŸ”§ Issues Fixed

---

## ğŸ” Issues Found

### Issue 1: Circular Dependency in Bootstrap
**Problem:** `_bootstrap.php` uses `safeHeader()` before `_helpers.php` is loaded.

**Location:** `source/dag/_bootstrap.php` line 43

**Fix:** Load `_helpers.php` BEFORE using `safeHeader()`:
```php
require_once __DIR__ . '/../vendor/autoload.php';
require_once __DIR__ . '/../global_function.php';
require_once __DIR__ . '/../model/member_class.php';
require_once __DIR__ . '/../permission.php';

// Load helpers BEFORE using safeHeader
require_once __DIR__ . '/_helpers.php';
```

**Status:** âœ… Fixed

---

### Issue 2: Duplicate Require in dag_graph_api.php
**Problem:** `dag_graph_api.php` requires both `_bootstrap.php` and `_helpers.php`, but `_bootstrap.php` already includes `_helpers.php`.

**Location:** `source/dag/dag_graph_api.php` line 35-36

**Fix:** Remove duplicate require:
```php
// Before
require_once __DIR__ . '/_bootstrap.php';
require_once __DIR__ . '/_helpers.php';

// After
// Note: _bootstrap.php already includes _helpers.php
require_once __DIR__ . '/_bootstrap.php';
```

**Status:** âœ… Fixed

---

### Issue 3: Missing Function Dependencies
**Problem:** `dag_graph_api.php` uses functions that need to be verified:
- `core_db()` - from `global_function.php` âœ… (loaded in `_bootstrap.php`)
- `tenant_permission_allow_code()` - from `permission.php` âœ… (loaded in `_bootstrap.php`)
- `set_cache_header()` - from `global_function.php` âœ… (loaded in `_bootstrap.php`)

**Status:** âœ… All dependencies available

---

## âœ… Verification

### Syntax Check
```bash
php -l source/dag/_bootstrap.php      # âœ… No syntax errors
php -l source/dag/_helpers.php        # âœ… No syntax errors
php -l source/dag/dag_graph_api.php  # âœ… No syntax errors
```

### Function Dependencies
- âœ… `safeHeader()` - defined in `_helpers.php`
- âœ… `setETagHeader()` - defined in `_helpers.php`
- âœ… `getGraphEtag()` - defined in `_helpers.php`
- âœ… `loadGraphWithVersion()` - defined in `_helpers.php`
- âœ… `must_allow_routing()` - defined in `_helpers.php`
- âœ… `core_db()` - from `global_function.php` (loaded in `_bootstrap.php`)
- âœ… `tenant_permission_allow_code()` - from `permission.php` (loaded in `_bootstrap.php`)
- âœ… `set_cache_header()` - from `global_function.php` (loaded in `_bootstrap.php`)
- âœ… `json_success()` - from `global_function.php` (loaded in `_bootstrap.php`)
- âœ… `json_error()` - from `global_function.php` (loaded in `_bootstrap.php`)
- âœ… `translate()` - from `global_function.php` (loaded in `_bootstrap.php`)

---

## ğŸ“‹ Current Status

### Files Created
1. âœ… `source/dag/_bootstrap.php` - Shared initialization
2. âœ… `source/dag/_helpers.php` - Helper functions
3. âœ… `source/dag/dag_graph_api.php` - Graph API (1 action: `graph_list`)

### Actions Implemented
- âœ… `graph_list` - Complete (528 lines)

### Actions Pending (Phase 2a)
- â¬œ `graph_get`
- â¬œ `graph_by_code` (deprecated)
- â¬œ `graph_view` (deprecated)
- â¬œ `graph_versions`
- â¬œ `graph_version_compare`
- â¬œ `compare_versions`

---

## ğŸ¯ Next Steps

1. **Add remaining read-only actions** to `dag_graph_api.php`:
   - Extract `graph_get` from `dag_routing_api.php` (line 1741)
   - Extract `graph_versions` from `dag_routing_api.php` (line 6519)
   - Extract `graph_version_compare` from `dag_routing_api.php` (line 6797)
   - Extract `compare_versions` from `dag_routing_api.php` (line 7324)
   - Add deprecated handlers for `graph_by_code` and `graph_view`

2. **Update `dag_routing_api.php`** to delegate read-only actions:
   - Add router logic to forward `graph_*` read-only actions to `dag_graph_api.php`

3. **Test all read-only actions**:
   - Verify `graph_list` works
   - Verify `graph_get` works
   - Verify version actions work
   - Verify deprecated actions return proper errors

4. **Deploy and monitor** (3-7 days)

---

## ğŸ“ Notes

- All syntax errors fixed
- All function dependencies verified
- Bootstrap order corrected
- Ready to continue with remaining actions

