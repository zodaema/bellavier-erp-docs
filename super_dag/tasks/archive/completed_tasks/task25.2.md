‡∏Ñ‡∏∏‡∏ì‡∏û‡∏π‡∏î‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö ‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ‡∏ú‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÅ‡∏ï‡πà‡∏™‡πà‡∏ß‡∏ô Patch ‡∏à‡∏ô‡∏Å‡∏•‡∏ö ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ task ‡∏´‡∏•‡∏±‡∏Å ‡πÑ‡∏õ‡πÄ‡∏≠‡∏á ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏°‡∏à‡∏£‡∏¥‡∏á ‡πÜ üòì
‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ú‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ‡πÑ‡∏ü‡∏•‡πå task25.2.md ‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏° ‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà:
	‚Ä¢	‡πÄ‡∏Å‡πá‡∏ö ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ Task ‡∏´‡∏•‡∏±‡∏Å (Classic Output Dashboard) ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
	‚Ä¢	‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏µ ‡∏™‡πà‡∏ß‡∏ô Patch ClassicProductionStatsService ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
	‚Ä¢	‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á Cursor ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢

‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏õ ‡πÅ‡∏ó‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ü‡∏•‡πå /docs/super_dag/tasks/task25.2.md ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö

‚∏ª


Task 25.2 ‚Äî Product Classic Output Dashboard (Classic Production Overview)

Phase: 25 ‚Äî Classic Line Stabilization  
Status: READY FOR IMPLEMENTATION  
Owner: System Engineering / Production Planning Module

‚∏ª

üéØ Objective

‡∏™‡∏£‡πâ‡∏≤‡∏á Dashboard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏ô Classic Line ‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚ÄúProduct Detail‚Äù ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á `production_output_daily`

Dashboard ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô ‚ÄúProduction Insight‚Äù ‡∏ä‡πà‡∏ß‡∏¢‡∏ú‡∏π‡πâ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤:
- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞ SKU ‡∏ñ‡∏π‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Å‡∏µ‡πà‡∏ä‡∏¥‡πâ‡∏ô  
- ‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏î‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£  
- ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (Lead time) ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏¢‡πà‡∏•‡∏á‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô

**‡∏Ç‡πâ‡∏≠‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç**

- Classic Line **‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ ETA / Simulation / Node Behavior**
- Dashboard ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å **‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏£‡∏¥‡∏á 100%** ‡∏à‡∏≤‡∏Å `production_output_daily`

‚∏ª

‚úî Scope ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°

1. API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
2. UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Product Detail
3. Charts (line graph) + Summary Cards
4. CSV Export
5. Pagination / Range Filters (‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 7/14/30/60/90 ‡∏ß‡∏±‡∏ô)

‚∏ª

üìå 1. API ‚Äî `product_stats_api.php?action=classic_dashboard`

**Request**

```http
GET product_stats_api.php?action=classic_dashboard&product_id=123&days=30

Response Structure (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)

{
  "ok": true,
  "product_id": 123,
  "days": 30,
  "summary": {
    "total_output": 481,
    "avg_per_day": 16,
    "best_day_qty": 42,
    "best_day_date": "2025-11-22",
    "worst_day_qty": 0,
    "worst_day_date": "2025-11-03"
  },
  "daily": [
    {
      "date": "2025-11-01",
      "qty": 12,
      "avg_lead_time_hours": 4.5
    },
    {
      "date": "2025-11-02",
      "qty": 19,
      "avg_lead_time_hours": 3.1
    }
  ],
  "lead_time_trend": [
    { "date": "2025-11-01", "hours": 4.5 },
    { "date": "2025-11-02", "hours": 3.1 }
  ]
}

‚∏ª

üìå 2. Backend Implementation (API)

‡πÑ‡∏ü‡∏•‡πå: product_stats_api.php

‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° case ‡πÉ‡∏´‡∏°‡πà:
	‚Ä¢	action=classic_dashboard

Validation
	‚Ä¢	product_id (int) ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ
	‚Ä¢	days ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏∏‡∏î: [7, 14, 30, 60, 90]
‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô 400 + error message

Query

SELECT date, qty, avg_lead_time_ms
FROM production_output_daily
WHERE id_product = ?
  AND date >= (CURRENT_DATE - INTERVAL ? DAY)
ORDER BY date ASC;

Compute ‡∏ù‡∏±‡πà‡∏á PHP
	‚Ä¢	total_output = sum(qty) ‡∏ó‡∏±‡πâ‡∏á‡∏ä‡πà‡∏ß‡∏á
	‚Ä¢	avg_per_day = total_output / days (round 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
	‚Ä¢	best_day_qty, best_day_date = ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà qty ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
	‚Ä¢	worst_day_qty, worst_day_date = ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà qty ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î
	‚Ä¢	avg_lead_time_hours ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô = avg_lead_time_ms / 3,600,000 (round 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
	‚Ä¢	lead_time_trend = array ‡∏Ç‡∏≠‡∏á {date, hours} ‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á

‚∏ª

üìå 3. UI ‚Äî Product Detail Page (views/product.php)

‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
	‚Ä¢	‡πÄ‡∏û‡∏¥‡πà‡∏° Section ‡πÉ‡∏ï‡πâ ‚ÄúProduct Info‚Äù

Section Title

Classic Production Overview

Summary Cards ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ
	‚Ä¢	‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï‡∏™‡∏∞‡∏™‡∏° N ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ï‡∏≤‡∏° range ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
	‚Ä¢	‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô
	‚Ä¢	‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)
	‚Ä¢	‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)

Chart
	‚Ä¢	Line chart: ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ú‡∏•‡∏¥‡∏ï‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (qty)
	‚Ä¢	Lead time trend: optional (‡∏à‡∏∞‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô dataset ‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ toggle ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ)

Controls
	‚Ä¢	Range buttons:
	‚Ä¢	[7 ‡∏ß‡∏±‡∏ô] [14 ‡∏ß‡∏±‡∏ô] [30 ‡∏ß‡∏±‡∏ô] [60 ‡∏ß‡∏±‡∏ô] [90 ‡∏ß‡∏±‡∏ô]
	‚Ä¢	‡∏õ‡∏∏‡πà‡∏°:
	‚Ä¢	[Export as CSV]

JS

‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà: assets/javascripts/classic_product_dashboard.js

Loading Flow
	1.	‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î product.php (Product Detail) ‚Üí script ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
	2.	Script ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ product_id ‡∏à‡∏≤‡∏Å hidden input ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠ element ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
	3.	‡∏¢‡∏¥‡∏á request ‡πÑ‡∏õ‡∏¢‡∏±‡∏á product_stats_api.php?action=classic_dashboard
	4.	Update summary cards
	5.	Render chart ‡∏î‡πâ‡∏ß‡∏¢ Chart.js
	‚Ä¢	‡πÉ‡∏ä‡πâ config ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (line chart)
	‚Ä¢	‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ custom style ‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)

‚∏ª

üìå 4. CSV Export

‡πÄ‡∏û‡∏¥‡πà‡∏° endpoint ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô product_stats_api.php:
	‚Ä¢	action=classic_dashboard_csv

Behavior
	‚Ä¢	Response ‡πÄ‡∏õ‡πá‡∏ô text/csv + header download
	‚Ä¢	‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: classic_output_<product_id>_<days>d.csv

Columns

date,qty,avg_lead_time_hours

Query ‡πÉ‡∏ä‡πâ‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö classic_dashboard ‡πÅ‡∏•‡πâ‡∏ß map ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô rows CSV

‚∏ª

üìå 5. Acceptance Criteria

Functional
	‚Ä¢	Dashboard ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Classic (production_output_daily) ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
	‚Ä¢	‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 30 ‡∏ß‡∏±‡∏ô: ‡∏Ñ‡∏ß‡∏£ ‚â§ 200ms ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö query + serialize (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô hard rule ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢)
	‚Ä¢	Selector ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (7/14/30/60/90 ‡∏ß‡∏±‡∏ô) ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞ chart/summary refresh ‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á
	‚Ä¢	CSV export ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö dashboard

Non-Functional
	‚Ä¢	UI ‡πÑ‡∏°‡πà block / ‡πÑ‡∏°‡πà timeout
	‚Ä¢	Summary cards ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏¢‡∏≠‡∏∞
	‚Ä¢	‡πÑ‡∏°‡πà‡∏°‡∏µ PHP warning / notice ‡πÉ‡∏ô logs ‡∏à‡∏≤‡∏Å endpoint ‡∏ô‡∏µ‡πâ

‚∏ª

üìå 6. Future-proofing
	‚Ä¢	Dashboard ‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡∏™‡∏π‡πà phase ‚ÄúForecasting‚Äù (‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ä‡πâ qty/day + lead time trend ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì capacity ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á)
	‚Ä¢	‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö ‚ÄúFactory Capacity Planning‚Äù ‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô schema ‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏Ñ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° field/‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°)

‚∏ª

üìå Deliverables
	1.	Updated API file: product_stats_api.php
	‚Ä¢	‡πÄ‡∏û‡∏¥‡πà‡∏° action classic_dashboard
	‚Ä¢	‡πÄ‡∏û‡∏¥‡πà‡∏° action classic_dashboard_csv
	2.	New JS file: assets/javascripts/classic_product_dashboard.js
	3.	Updated View file: views/product.php
	‚Ä¢	‡πÄ‡∏û‡∏¥‡πà‡∏° Classic Production Overview section
	4.	CSV Export logic ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏° spec
	5.	Documentation file: docs/super_dag/tasks/results/task25_2_results.md

‚∏ª
‚∏ª

üîß Appendix A ‚Äî Patch ClassicProductionStatsService (Task 25.2 ‚Äì Patch Classic Line Aggregation)

‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: Section ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ ‡πÄ‡∏™‡∏£‡∏¥‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Classic Line Aggregation ‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
‡πÉ‡∏´‡πâ Cursor ‡πÅ‡∏Å‡πâ‡πÑ‡∏ü‡∏•‡πå ClassicProductionStatsService.php ‡∏ï‡∏≤‡∏° step ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö oboe)

Target File

source/BGERP/Service/ClassicProductionStatsService.php

‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Patch
	1.	‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ operator sessions ‡∏Å‡πà‡∏≠‡∏ô target_qty
	2.	‡∏ó‡∏≥‡πÉ‡∏´‡πâ aggregation ‡πÄ‡∏õ‡πá‡∏ô idempotent ‡∏ï‡πà‡∏≠ ticket (‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥)
	3.	‡πÄ‡∏û‡∏¥‡πà‡∏° comment ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ß‡πà‡∏≤ OEM = Classic line ‡πÉ‡∏ô schema ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

‚∏ª

(1) recordCompleteFromTicket() ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å completed quantity

‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡πÄ‡∏°‡∏ò‡∏≠‡∏î recordCompleteFromTicket() ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå:

// Get completed quantity
if ($completedQty === null || $completedQty <= 0) {
    // Fallback: Use target_qty or completed_qty from session
    $completedQty = (int)($ticket['target_qty'] ?? 0);
    
    // Try to get actual completed qty from operator sessions
    if ($completedQty <= 0) {
        $completedQty = $this->getCompletedQtyFromSessions($ticketId);
    }
}

‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢:

// Get completed quantity
if ($completedQty === null || $completedQty <= 0) {
    // Prefer actual completed qty from operator sessions
    $completedQty = $this->getCompletedQtyFromSessions($ticketId);

    // Fallback: use target_qty from ticket if sessions have no data
    if ($completedQty <= 0) {
        $completedQty = (int)($ticket['target_qty'] ?? 0);
    }
}


‚∏ª

(2) aggregateDailyOutputForDate() ‚Äî ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ sessions ‡∏Å‡πà‡∏≠‡∏ô target_qty

‡πÉ‡∏ô‡πÄ‡∏°‡∏ò‡∏≠‡∏î aggregateDailyOutputForDate() ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì $qty ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏•‡∏π‡∏õ:

‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á):

$qty = (int)($row['target_qty'] ?? 0);
if ($qty <= 0) {
    $qty = $this->getCompletedQtyFromSessions($ticketId);
}

‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô:

// Prefer actual completed qty from operator sessions
$qty = $this->getCompletedQtyFromSessions($ticketId);
if ($qty <= 0) {
    // Fallback to target_qty if sessions have no data
    $qty = (int)($row['target_qty'] ?? 0);
}


‚∏ª

(3) aggregateDailyOutput() ‚Äî ‡∏ó‡∏≥‡πÉ‡∏´‡πâ idempotent ‡∏ï‡πà‡∏≠ ticket

‡πÉ‡∏ô‡πÄ‡∏°‡∏ò‡∏≠‡∏î:

private function aggregateDailyOutput(
    int $productId,
    string $date,
    int $qty,
    int $leadTimeMs,
    int $totalLeadTimeMs,
    int $ticketId
): void

‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î:

$existing = $this->getDailyOutput($productId, $date);

‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏£‡∏Å:

// If this ticket has already been aggregated for this date, do nothing (idempotent)
if ($existing) {
    $existingTicketIds = json_decode($existing['source_job_ticket_ids'] ?? '[]', true) ?: [];
    if (in_array($ticketId, $existingTicketIds, true)) {
        error_log("[ClassicProductionStatsService] Ticket {$ticketId} already aggregated for {$productId} on {$date}, skipping.");
        return;
    }
}

‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡πâ‡∏≤‡∏¢ ‡πÜ ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ò‡∏≠‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ Cursor ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á):

if ($existing) {
    // Update existing row (additive aggregation)
    $newQty = $existing['qty'] + $qty;
    $newTotalLeadTimeMs = $existing['total_lead_time_ms'] + $totalLeadTimeMs;
    $newAvgLeadTimeMs = (int)($newTotalLeadTimeMs / $newQty);

    // Update ticket IDs JSON array
    $ticketIds = json_decode($existing['source_job_ticket_ids'] ?? '[]', true) ?: [];
    if (!in_array($ticketId, $ticketIds, true)) {
        $ticketIds[] = $ticketId;
    }

    $this->updateDailyOutput(
        $productId,
        $date,
        $newQty,
        $newAvgLeadTimeMs,
        $newTotalLeadTimeMs,
        $ticketIds
    );
} else {
    // Insert new row
    $this->insertDailyOutput(
        $productId,
        $date,
        $qty,
        $leadTimeMs,
        $totalLeadTimeMs,
        [$ticketId]
    );
}


‚∏ª

(4) ‡πÄ‡∏û‡∏¥‡πà‡∏° comment ‡∏ß‡πà‡∏≤ OEM = Classic line

‡∏ó‡∏µ‡πà docblock ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏•‡∏≤‡∏™ (‡∏Å‡πà‡∏≠‡∏ô class ClassicProductionStatsService):

‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ:

/**
 * Classic Production Statistics Service
 * 
 * Task 25.1: Product Output Analytics (Classic Line)
 * 
 * Purpose: Collect and aggregate production statistics for Classic Line tickets
 * - Stores daily aggregated production output per product
 * - Calculates lead time metrics
 * - Supports idempotent operations (no double-counting)
 * 
 * @package BGERP\Service
 * @version 1.0
 */

‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î:

 * Note: In the current schema, production_type = 'oem' is used for the Classic line.

‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô:

/**
 * Classic Production Statistics Service
 * 
 * Task 25.1: Product Output Analytics (Classic Line)
 * 
 * Purpose: Collect and aggregate production statistics for Classic Line tickets
 * - Stores daily aggregated production output per product
 * - Calculates lead time metrics
 * - Supports idempotent operations (no double-counting)
 * 
 * Note: In the current schema, production_type = 'oem' is used for the Classic line.
 * 
 * @package BGERP\Service
 * @version 1.0
 */


‚∏ª

‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ Cursor ‡∏£‡∏±‡∏ô:

php -l source/BGERP/Service/ClassicProductionStatsService.php

‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ syntax ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á

‚∏ª

‡∏à‡∏ö Task 25.2:
	‚Ä¢	‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô = Spec ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Classic Output Dashboard
	‚Ä¢	‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á = Patch ‡πÄ‡∏™‡∏£‡∏¥‡∏° ClassicProductionStatsService ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Cursor

---

**Status:** ‚úÖ **COMPLETED** (2025-11-30)  
**Results:** [task25_2_results.md](results/task25_2_results.md)
