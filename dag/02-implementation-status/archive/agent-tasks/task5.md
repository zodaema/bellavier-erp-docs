üß† Prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI Agent ‚Äî Task 5: Serial Number Hardening Layer (Stage 1 ‚Äì Detection & Observability)

‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
	‚Ä¢	‡∏´‡πâ‡∏≤‡∏° copy ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å prompt ‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á ‡πÜ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á
	‚Ä¢	‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏∏‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á / pseudo-code ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
	‚Ä¢	‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á open ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á ‡∏ï‡∏£‡∏ß‡∏à context ‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ modify ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå

‚∏ª

üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Task 5

‡∏ó‡∏≥ Serial Number Hardening Layer ‚Äì Stage 1 (Detection & Observability ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
	1.	‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äú‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‚Äù ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö serial:
	‚Ä¢	‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö serial ‡∏ã‡πâ‡∏≥ / ‡∏ú‡∏¥‡∏î format / ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö token ‡∏ú‡∏¥‡∏î
	‚Ä¢	‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Ç‡∏±‡πâ‡∏ô block ‡∏£‡∏∞‡∏ö‡∏ö)
	2.	‡πÄ‡∏û‡∏¥‡πà‡∏° tools + logs ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á serial:
	‚Ä¢	‡∏ï‡∏£‡∏ß‡∏à‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• serial_registry, job_ticket_serial, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö flow_token
	‚Ä¢	‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ô‡πÅ‡∏ö‡∏ö diagnostic (CLI) ‡∏î‡∏π‡∏ú‡∏•‡∏£‡∏ß‡∏° / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏î‡πâ
	3.	‡πÄ‡∏û‡∏¥‡πà‡∏° tests ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö layer ‡∏ô‡∏µ‡πâ:
	‚Ä¢	Unit / Integration ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
	‚Ä¢	‡πÑ‡∏°‡πà‡∏°‡∏µ regression ‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô UnifiedSerialServiceTest, E2E Hatthasilpa

Stage ‡∏ô‡∏µ‡πâ‡πÄ‡∏ô‡πâ‡∏ô ‚Äú‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö + log + tools‚Äù ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ ‚ÄúDanger Mode‚Äù (‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö)
Enforcement (‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏¢‡∏ô exception, ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£ assign token) ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô Task ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ

‚∏ª

üîé Context ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ

‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏î‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á):
	1.	Serial Core
	‚Ä¢	source/BGERP/Service/UnifiedSerialService.php
	‚Ä¢	source/BGERP/Service/SerialManagementService.php
	‚Ä¢	source/BGERP/Service/JobCreationService.php
	2.	Entry Points ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö serial
	‚Ä¢	source/hatthasilpa_job_ticket.php
	‚Ä¢	source/dag_token_api.php
	3.	Tests ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
	‚Ä¢	tests/Unit/UnifiedSerialServiceTest.php
	‚Ä¢	tests/Integration/HatthasilpaE2E_SerialStdEnforcementTest.php
	‚Ä¢	E2E ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏∞ serial ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
	4.	Schema / DB
	‚Ä¢	‡∏ï‡∏≤‡∏£‡∏≤‡∏á serial_registry
	‚Ä¢	‡∏ï‡∏≤‡∏£‡∏≤‡∏á job_ticket_serial
	‚Ä¢	‡∏ï‡∏≤‡∏£‡∏≤‡∏á token ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å serial (‡πÄ‡∏ä‡πà‡∏ô flow_token.serial_number, ‡∏Ø‡∏•‡∏Ø)
	5.	‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
	‚Ä¢	docs/dag/master/*.md ‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á serial
	‚Ä¢	docs/dag/agent-tasks/task4_OPERATOR_AVAILABILITY_SCHEMA.md (‡∏î‡∏π pattern doc & summary)

‚∏ª

üß© Scope ‡∏á‡∏≤‡∏ô (Stage 1 ‚Äì Detection Layer)

1) ‡πÄ‡∏û‡∏¥‡πà‡∏° Serial Health Checker / Conflict Detector (Service ‡πÉ‡∏´‡∏°‡πà)
‡∏™‡∏£‡πâ‡∏≤‡∏á class ‡πÉ‡∏´‡∏°‡πà (‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥):
	‚Ä¢	BGERP\Service\SerialHealthService
	‚Ä¢	‡πÉ‡∏ä‡πâ core DB (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô UnifiedSerialService)
	‚Ä¢	‡πÄ‡∏ô‡πâ‡∏ô ‡∏≠‡πà‡∏≤‡∏ô / ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / log ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Äî ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô state (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô log)

‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢:

// ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ signature ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á
public function checkJobSerialHealth(int $jobTicketId): array;
public function checkTenantSerialHealth(int $tenantId, int $limit = 1000): array;

‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏ô checkJobSerialHealth (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á logic):
	‚Ä¢	‡∏ô‡∏±‡∏ö serial ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô:
	‚Ä¢	job_ticket_serial ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö $jobTicketId
	‚Ä¢	serial_registry ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö job/ticket ‡∏ô‡∏±‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ field ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á)
	‚Ä¢	serial ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö token ‡πÉ‡∏ô flow_token (‡∏´‡∏£‡∏∑‡∏≠ table ‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ä‡πâ)
	‚Ä¢	‡∏´‡∏≤ anomalies ‡πÄ‡∏ä‡πà‡∏ô:
	‚Ä¢	serial ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÉ‡∏ô serial_registry (serial_code ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tenant ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
	‚Ä¢	serial ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô serial_registry ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô job_ticket_serial ‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ
	‚Ä¢	token ‡∏°‡∏µ serial ‡πÅ‡∏ï‡πà serial ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô serial_registry
	‚Ä¢	serial ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏≠‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢ token ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
	‚Ä¢	return ‡∏ú‡∏•‡πÅ‡∏ö‡∏ö structured ‡πÄ‡∏ä‡πà‡∏ô:

[
  'ok' => true/false,
  'job_ticket_id' => 631,
  'counts' => [
      'registry' => 30,
      'job_ticket_serial' => 30,
      'tokens_with_serial' => 30,
  ],
  'issues' => [
      // array ‡∏Ç‡∏≠‡∏á anomaly objects
      ['type' => 'DUPLICATE_SERIAL_IN_REGISTRY', 'serial_code' => '...', 'rows' => 2 ],
      ['type' => 'TOKEN_WITHOUT_REGISTRY_ENTRY', 'token_id' => 1234, 'serial_code' => '...' ],
      // ...
  ],
]

‚ö†Ô∏è ‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡∏Ñ‡∏∑‡∏≠ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á response ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
‡πÇ‡∏õ‡∏£‡∏î‡∏î‡∏π‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á

2) Hook ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏Å SerialHealthService ‡πÅ‡∏ö‡∏ö ‚ÄúSoft‚Äù
‡πÄ‡∏û‡∏¥‡πà‡∏° hook ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÅ‡∏ï‡πà ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö soft-only:
	‚Ä¢	‡πÉ‡∏ô JobCreationService::createFromBinding() (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å pre-generate + link serial ‡πÄ‡∏™‡∏£‡πá‡∏à)
	‚Ä¢	(‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô) ‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡πà‡∏ô generateAdditionalSerialsForJob ‡∏´‡∏£‡∏∑‡∏≠ handler ‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ ‡πÜ ‡∏Å‡∏±‡∏ô

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î:

try {
    $health = $serialHealthService->checkJobSerialHealth($jobTicketId);
    if (!($health['ok'] ?? true)) {
        error_log("[SerialHealth] Job {$jobTicketId} has anomalies: " . json_encode($health['issues']));
    }
} catch (\Throwable $e) {
    // ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ health check ‡∏ó‡∏≥‡πÉ‡∏´‡πâ flow ‡∏´‡∏•‡∏±‡∏Å‡∏•‡πâ‡∏°
    error_log("[SerialHealth] ERROR while checking job {$jobTicketId}: " . $e->getMessage());
}

‚ö†Ô∏è ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á pattern ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Ñ wiring ‡∏Ç‡∏≠‡∏á service, DI, constructor pattern ‡∏Ç‡∏≠‡∏á BGERP\Service ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡∏à‡∏£‡∏¥‡∏á

‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
	‚Ä¢	‡∏¢‡∏±‡∏á ‡πÑ‡∏°‡πà ‡πÉ‡∏´‡πâ health check ‡πÇ‡∏¢‡∏ô exception ‡πÑ‡∏õ‡∏´‡∏¢‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å
	‚Ä¢	‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÉ‡∏´‡πâ log ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô, ‡πÅ‡∏ï‡πà ok ‡∏à‡∏≤‡∏Å API/Service ‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô true ‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏î‡∏¥‡∏°

3) Diagnostic CLI Script
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô tools/ (pattern ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô tools/serial_registry_check.php):

‡πÄ‡∏ä‡πà‡∏ô:
	‚Ä¢	tools/serial_health_check.php

‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô:
	‚Ä¢	‡∏£‡∏±‡∏ö parameter ‡πÄ‡∏ä‡πà‡∏ô:
	‚Ä¢	--job=631 ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å checkJobSerialHealth(631) ‡πÅ‡∏•‡πâ‡∏ß print summary + issues
	‚Ä¢	--tenant=2 ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å checkTenantSerialHealth(2) ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡∏∏‡∏õ aggregate
	‚Ä¢	‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô CLI:
	‚Ä¢	‡∏£‡∏ß‡∏° count ‡∏ï‡πà‡∏≤‡∏á ‡πÜ
	‚Ä¢	‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ anomalies (limit: ‡πÄ‡∏ä‡πà‡∏ô 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô)

Pseudo:

$options = getopt('', ['job::', 'tenant::', 'limit::']);

// bootstrap core_db(), autoload, etc.

$service = new SerialHealthService($coreDb);

if (!empty($options['job'])) {
    $result = $service->checkJobSerialHealth((int)$options['job']);
    // echo summary + issues
}

‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏ä‡πâ bootstrap pattern ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö tools ‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô repo
‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå tools ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ copy pattern

4) Logs & Observability
‡πÄ‡∏û‡∏¥‡πà‡∏° log ‡πÅ‡∏ö‡∏ö ‡πÑ‡∏°‡πà‡∏£‡∏Å ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå ‡πÄ‡∏ä‡πà‡∏ô:
	‚Ä¢	‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠ anomaly ‡πÉ‡∏ô health check:
	‚Ä¢	[SerialHealth][Job:631] DUPLICATE_SERIAL_IN_REGISTRY code=... rows=2
	‚Ä¢	[SerialHealth][Job:631] TOKEN_WITHOUT_REGISTRY_ENTRY token=... serial=...

‡∏≠‡∏¢‡πà‡∏≤ log ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏™‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏à‡∏∞ spam log)
Log ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏û‡∏ö issues ‡∏´‡∏£‡∏∑‡∏≠ error ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô health check ‡πÄ‡∏≠‡∏á

‚∏ª

üß™ Tests ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
	1.	Unit Tests ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SerialHealthService

‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ä‡πà‡∏ô:
	‚Ä¢	tests/Unit/SerialHealthServiceTest.php

‡πÄ‡∏Ñ‡∏™‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢:
	‚Ä¢	job ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏°‡∏µ anomaly) ‚Üí ok=true, issues=[]
	‚Ä¢	job ‡∏°‡∏µ serial ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô serial_registry ‚Üí ok=false ‡πÅ‡∏•‡∏∞‡∏°‡∏µ issue type DUPLICATE_SERIAL_IN_REGISTRY
	‚Ä¢	job ‡∏°‡∏µ token ‡∏ú‡∏π‡∏Å serial ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô serial_registry ‚Üí issue type TOKEN_WITHOUT_REGISTRY_ENTRY

‚ö†Ô∏è ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô environment test ‡πÑ‡∏°‡πà‡∏°‡∏µ schema ‡πÄ‡∏ï‡πá‡∏° ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ pattern ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö E2E tests ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ:
	‚Ä¢	‡πÄ‡∏ä‡πá‡∏Ñ schema ‡∏Å‡πà‡∏≠‡∏ô (tableHasColumns)
	‚Ä¢	‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‚Üí mark test ‡πÄ‡∏õ‡πá‡∏ô skipped

	2.	Integration / E2E Light

‡∏≠‡∏≤‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏° test ‡πÄ‡∏ö‡∏≤ ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô:
	‚Ä¢	‡πÉ‡∏ä‡πâ flow ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ä‡πà‡∏ô create job + spawn token)
	‚Ä¢	‡πÄ‡∏£‡∏µ‡∏¢‡∏Å health check ‡πÅ‡∏•‡πâ‡∏ß assert ‡∏ß‡πà‡∏≤ ok=true ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö case base-line

‚∏ª

üîê ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î & ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡πÉ‡∏ô Task ‡∏ô‡∏µ‡πâ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
	‚Ä¢	‚ùå ‡∏´‡πâ‡∏≤‡∏° ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô behavior ‡∏Ç‡∏≠‡∏á UnifiedSerialService::generateSerial() ‡∏´‡∏£‡∏∑‡∏≠ registerSerial() ‡πÉ‡∏ô‡πÄ‡∏ä‡∏¥‡∏á enforcement (‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏¢‡∏ô exception ‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
	‚Ä¢	‡πÄ‡∏£‡∏≤‡∏ó‡∏≥ Stage 1 = detection/observability ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
	‚Ä¢	‚ùå ‡∏´‡πâ‡∏≤‡∏° ‡πÄ‡∏û‡∏¥‡πà‡∏° UNIQUE constraint ‡∏´‡∏£‡∏∑‡∏≠ alter schema ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô DB (‡∏ó‡∏±‡πâ‡∏á coredb / tenant DB) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Task ‡∏ô‡∏µ‡πâ
	‚Ä¢	‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏™‡∏ô‡∏≠ ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ comment TODO ‡πÅ‡∏ó‡∏ô
	‚Ä¢	‚ùå ‡∏´‡πâ‡∏≤‡∏° ‡∏ó‡∏≥‡πÉ‡∏´‡πâ E2E ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏û‡∏±‡∏á ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞:
	‚Ä¢	HatthasilpaE2E_SerialStdEnforcementTest
	‚Ä¢	HatthasilpaE2E_WorkQueueFilterTest
	‚Ä¢	‚ùå ‡∏´‡πâ‡∏≤‡∏° ‡∏õ‡∏£‡∏±‡∏ö config / feature_flag ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á

‚∏ª

üìÑ Documentation ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°

‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà:
	‚Ä¢	docs/dag/agent-tasks/task5_SERIAL_HARDENING.md

‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ:
	1.	Problem Statement
	2.	What SerialHealthService does
	3.	What anomalies are detected (type list)
	4.	How to run CLI tool (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á)
	5.	Limitations (Stage 1 = detection only, no enforcement)
	6.	Plan ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Stage 2 (Danger Mode / enforcement) ‡πÄ‡∏õ‡πá‡∏ô TODO

‚∏ª

‚úÖ Definition of Done (DoD) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Task 5

Task 5 ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ ‚Äú‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‚Äù ‡πÄ‡∏°‡∏∑‡πà‡∏≠:
	1.	‡∏°‡∏µ SerialHealthService (‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤) ‡∏û‡∏£‡πâ‡∏≠‡∏° functions ‡∏ï‡∏£‡∏ß‡∏à health ‡∏ï‡∏≤‡∏° scope
	2.	‡∏°‡∏µ CLI tool tools/serial_health_check.php ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
	3.	‡∏°‡∏µ Unit Tests ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÑ‡∏ü‡∏•‡πå + ‡∏ú‡πà‡∏≤‡∏ô (‡∏´‡∏£‡∏∑‡∏≠ skip correct ‡∏ï‡∏≤‡∏° schema)
	4.	E2E / Integration ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:
	‚Ä¢	‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ú‡πà‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ skip ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ skip
	5.	Log ‡πÅ‡∏™‡∏î‡∏á anomaly ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á case ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
	6.	‡∏°‡∏µ doc task5_SERIAL_HARDENING.md ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô + ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ

‚∏ª

‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß
‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å:
	1.	‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå serial services ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
	2.	Sketch design ‡∏Ç‡∏≠‡∏á SerialHealthService ‡∏ö‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©/‡πÉ‡∏ô comment ‡∏Å‡πà‡∏≠‡∏ô
	3.	‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡∏á‡∏°‡∏∑‡∏≠ implement ‡πÅ‡∏ö‡∏ö‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ + ‡∏£‡∏±‡∏ô PHPUnit ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞